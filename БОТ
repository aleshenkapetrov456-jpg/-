from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes, CallbackContext
import requests
import json
from datetime import datetime, timedelta
import asyncio

BOT_TOKEN = "7796919987:AAHXdF2IOxgUNZyRazYENBLSrxTRZE_DyCI"
YOUR_CHAT_ID = 1891586130  # –í–∞—à ID
WEATHER_API_KEY = "your_openweather_api_key_here"  # –ü–æ–ª—É—á–∏—Ç–µ –Ω–∞ openweathermap.org

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
reminders = {}

async def forward_to_owner(update: Update, context: ContextTypes.DEFAULT_TYPE, bot_response: str = None):
    try:
        user_info = f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {update.message.from_user.first_name}"
        user_message = f"üí¨ –°–æ–æ–±—â–µ–Ω–∏–µ: {update.message.text}"

        full_text = f"{user_info}\n{user_message}"

        if bot_response:
            full_text += f"\nü§ñ –û—Ç–≤–µ—Ç –±–æ—Ç–∞: {bot_response}"

        await context.bot.send_message(chat_id=YOUR_CHAT_ID, text=full_text)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Å—ã–ª–∫–∏: {e}")

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    response = (
        "–ü—Ä–∏–≤–µ—Ç! –Ø —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç, —Å–æ–∑–¥–∞–Ω–Ω—ã–π –æ–¥–Ω–∏–º –æ—á–µ–Ω—å —É–º–Ω—ã–º –∏ —Ö–æ—Ä–æ—à–∏–º —á–µ–ª–æ–≤–µ–∫–æ–º!\n\n"
        "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
        "/start - –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É\n"
        "/remind - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ\n"
        "/weather - —É–∑–Ω–∞—Ç—å –ø–æ–≥–æ–¥—É\n"
        "/reminders - –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"
    )
    await update.message.reply_text(response)
    await forward_to_owner(update, context, response)

# –ö–æ–º–∞–Ω–¥–∞ /remind - —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
async def remind_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        help_text = (
            "üêæ **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:**\n\n"
            "–§–æ—Ä–º–∞—Ç—ã –≤—Ä–µ–º–µ–Ω–∏:\n"
            "‚Ä¢ `/remind 10–º –ø–æ–∫–æ—Ä–º–∏—Ç—å –∫–æ—Ç–∞` - —á–µ—Ä–µ–∑ 10 –º–∏–Ω—É—Ç\n"
            "‚Ä¢ `/remind 1—á –ø–æ–∑–≤–æ–Ω–∏—Ç—å –º–∞–º–µ` - —á–µ—Ä–µ–∑ 1 —á–∞—Å\n"
            "‚Ä¢ `/remind 18:30 –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–µ—Ä–∏–∞–ª` - –≤ 18:30\n\n"
            "–î—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "‚Ä¢ `/reminders` - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è"
        )
        await update.message.reply_text(help_text)
        await forward_to_owner(update, context, "–ü–æ–∫–∞–∑–∞–ª —Å–ø—Ä–∞–≤–∫—É –ø–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è–º")
        return

    user_input = ' '.join(context.args)
    user_id = update.message.from_user.id
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
    if user_input.lower() == 'list' or user_input.lower() == '–≤—Å–µ':
        await show_reminders(update, context)
        return
    
    # –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
    time_delay, reminder_message = parse_reminder_time(user_input)
    
    if not time_delay or not reminder_message:
        response = "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /remind 10–º —Ç–µ–∫—Å—Ç –∏–ª–∏ /remind 18:30 —Ç–µ–∫—Å—Ç"
        await update.message.reply_text(response)
        await forward_to_owner(update, context, response)
        return
    
    # –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    reminder_id = f"{user_id}_{datetime.now().timestamp()}"
    
    # –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    trigger_time = datetime.now() + timedelta(minutes=time_delay)
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
    reminders[reminder_id] = {
        'user_id': user_id,
        'message': reminder_message,
        'time': trigger_time,
        'chat_id': update.message.chat_id
    }
    
    response = f"‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!\n‚è∞ –°—Ä–∞–±–æ—Ç–∞–µ—Ç: {trigger_time.strftime('%H:%M %d.%m')}\nüí¨ –¢–µ–∫—Å—Ç: {reminder_message}\n\n‚ö†Ô∏è –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –∫–æ–≥–¥–∞ —è –±—É–¥—É –∞–∫—Ç–∏–≤–µ–Ω"
    await update.message.reply_text(response)
    await forward_to_owner(update, context, f"–£—Å—Ç–∞–Ω–æ–≤–∏–ª –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: {reminder_message}")

# –§—É–Ω–∫—Ü–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
def parse_reminder_time(text):
    text = text.lower().strip()
    
    # –ß–µ—Ä–µ–∑ X –º–∏–Ω—É—Ç (10–º, 30–º–∏–Ω—É—Ç)
    if '–º' in text and not '—á' in text:
        try:
            parts = text.split('–º', 1)
            minutes = int(''.join(filter(str.isdigit, parts[0])))
            message = parts[1].strip()
            return minutes, message
        except:
            return None, None
    
    # –ß–µ—Ä–µ–∑ X —á–∞—Å–æ–≤ (1—á, 2—á–∞—Å–∞)
    elif '—á' in text:
        try:
            parts = text.split('—á', 1)
            hours = int(''.join(filter(str.isdigit, parts[0])))
            message = parts[1].strip()
            return hours * 60, message
        except:
            return None, None
    
    # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è (18:30)
    elif ':' in text:
        try:
            time_part = text.split()[0]
            message = ' '.join(text.split()[1:])
            hours, minutes = map(int, time_part.split(':'))
            
            now = datetime.now()
            trigger_time = now.replace(hour=hours, minute=minutes, second=0, microsecond=0)
            
            # –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è, —Å—Ç–∞–≤–∏–º –Ω–∞ –∑–∞–≤—Ç—Ä–∞
            if trigger_time < now:
                trigger_time += timedelta(days=1)
            
            time_delay = (trigger_time - now).total_seconds() / 60
            return int(time_delay), message
        except:
            return None, None
    
    return None, None

# –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
async def show_reminders(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    user_reminders = {k: v for k, v in reminders.items() if v['user_id'] == user_id}
    
    if not user_reminders:
        response = "üìù –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π"
        await update.message.reply_text(response)
        await forward_to_owner(update, context, response)
        return
    
    response = "üìã –í–∞—à–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è:\n\n"
    for rem_id, reminder in user_reminders.items():
        time_str = reminder['time'].strftime('%H:%M %d.%m')
        short_id = rem_id[-6:]
        response += f"‚è∞ {reminder['message']}\nüïí {time_str}\nüîó ID: {short_id}\n\n"
    
    await update.message.reply_text(response)
    await forward_to_owner(update, context, "–ü–æ–∫–∞–∑–∞–ª —Å–ø–∏—Å–æ–∫ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π")

# –ö–æ–º–∞–Ω–¥–∞ /weather - –ø–æ–≥–æ–¥–∞
async def weather_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not context.args:
        response = "üå§ –£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥: /weather –ú–æ—Å–∫–≤–∞"
        await update.message.reply_text(response)
        await forward_to_owner(update, context, response)
        return
    
    city = ' '.join(context.args)
    
    try:
        # –ï—Å–ª–∏ API –∫–ª—é—á –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ-–æ—Ç–≤–µ—Ç
        if WEATHER_API_KEY == "your_openweather_api_key_here":
            response = (
                f"üå§ **–î–µ–º–æ-–ø–æ–≥–æ–¥–∞ –¥–ª—è {city}**\n\n"
                f"üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: 20¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ 18¬∞C)\n"
                f"üìù –°–æ–ª–Ω–µ—á–Ω–æ\n"
                f"üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: 65%\n\n"
                f"‚ö†Ô∏è –î–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ–Ω–∏—Ç–µ WEATHER_API_KEY –≤ –∫–æ–¥–µ"
            )
        else:
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞
            geo_url = f"http://api.openweathermap.org/geo/1.0/direct?q={city}&limit=1&appid={WEATHER_API_KEY}"
            geo_response = requests.get(geo_url)
            geo_data = geo_response.json()
            
            if not geo_data:
                response = f"‚ùå –ì–æ—Ä–æ–¥ '{city}' –Ω–µ –Ω–∞–π–¥–µ–Ω"
                await update.message.reply_text(response)
                await forward_to_owner(update, context, response)
                return
            
            lat = geo_data[0]['lat']
            lon = geo_data[0]['lon']
            
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
            weather_url = f"https://api.openweathermap.org/data/2.5/weather?lat={lat}&lon={lon}&appid={WEATHER_API_KEY}&units=metric&lang=ru"
            weather_response = requests.get(weather_url)
            weather_data = weather_response.json()
            
            if weather_response.status_code != 200:
                response = "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ"
                await update.message.reply_text(response)
                await forward_to_owner(update, context, response)
                return
            
            # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            temp = round(weather_data['main']['temp'])
            feels_like = round(weather_data['main']['feels_like'])
            humidity = weather_data['main']['humidity']
            description = weather_data['weather'][0]['description'].capitalize()
            city_name = weather_data['name']
            
            # –≠–º–æ–¥–∑–∏ –¥–ª—è –ø–æ–≥–æ–¥—ã
            weather_emoji = get_weather_emoji(weather_data['weather'][0]['main'])
            
            response = (
                f"{weather_emoji} **–ü–æ–≥–æ–¥–∞ –≤ {city_name}**\n\n"
                f"üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels_like}¬∞C)\n"
                f"üìù {description}\n"
                f"üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity}%"
            )
        
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã: {e}")
        response = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã."
    
    await update.message.reply_text(response)
    await forward_to_owner(update, context, f"–ó–∞–ø—Ä–æ—Å–∏–ª –ø–æ–≥–æ–¥—É –¥–ª—è: {city}")

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–º–æ–¥–∑–∏ –ø–æ–≥–æ–¥—ã
def get_weather_emoji(weather_main):
    emoji_map = {
        'Clear': '‚òÄÔ∏è',
        'Clouds': '‚òÅÔ∏è',
        'Rain': 'üåß',
        'Drizzle': 'üå¶',
        'Thunderstorm': '‚õà',
        'Snow': '‚ùÑÔ∏è',
        'Mist': 'üå´',
        'Fog': 'üå´'
    }
    return emoji_map.get(weather_main, 'üå§')

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
async def reminders_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await show_reminders(update, context)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏)
async def check_reminders(context: CallbackContext):
    now = datetime.now()
    reminders_to_remove = []
    
    for reminder_id, reminder in reminders.items():
        if reminder['time'] <= now:
            try:
                await context.bot.send_message(
                    chat_id=reminder['chat_id'],
                    text=f"‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ! üêæ\n{reminder['message']}"
                )
                reminders_to_remove.append(reminder_id)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")
    
    # –£–¥–∞–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
    for reminder_id in reminders_to_remove:
        del reminders[reminder_id]

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower()

    bad_words = ["–±–ª—è—Ç—å", "–±–ª—è–¥—å", "—Å—É–∫–∞", "—Ö—É–π", "–ø–∏–∑–¥–∞", "–Ω–∞—Ö—É–π", "–ø–∏–¥–æ—Ä", "–ø–∏–¥–æ—Ä–∞—Å", "–ø–∏–¥–æ—Ä–∞—Å–∏–Ω–∞", "–ø–∏–∑–¥–µ—Ü"]
    greeting_words = ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "—Ö–∞–π", "hello", "hi", "—Å–∞–ª—é—Ç", "–±–æ–Ω–∂—É—Ä", "—Å–∞–ª–∞–º","—Å–∞–ø"]

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –º–∞—Ç–µ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞
    if any(bad_word in text for bad_word in bad_words):
        response = "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã—Ä–∞–∂–∞–π—Ç–µ—Å—å –≤–µ–∂–ª–∏–≤–æ!"
        await update.message.reply_text(response)
        await forward_to_owner(update, context, response)
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
    if text in greeting_words:
        response = "–ü—Ä–∏–≤–µ—Ç —Å–Ω–æ–≤–∞!"
        await update.message.reply_text(response)
        await forward_to_owner(update, context, response)
        return

    # –î–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    response = "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –ø–æ–∫–∞ –Ω–µ –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ –≤—ã —Å–µ–π—á–∞—Å –≥–æ–≤–æ—Ä–∏—Ç–µ"
    await update.message.reply_text(response)
    await forward_to_owner(update, context, response)

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    application = Application.builder().token(BOT_TOKEN).build()

    # –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("remind", remind_command))
    application.add_handler(CommandHandler("weather", weather_command))
    application.add_handler(CommandHandler("reminders", reminders_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

    # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥)
    job_queue = application.job_queue
    job_queue.run_repeating(check_reminders, interval=30, first=10)

    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    application.run_polling()

if __name__ == "__main__":
    main()
